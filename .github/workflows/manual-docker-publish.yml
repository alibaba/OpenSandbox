name: Manual Docker Publish

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build'
        required: true
        type: choice
        options:
          - execd
          - code-interpreter
          - ingress
          - egress
        default: 'execd'
      image_tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
  push:
    tags:
      - 'docker/execd/**'
      - 'docker/code-interpreter/**'
      - 'docker/ingress/**'
      - 'docker/egress/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: sandbox-registry.cn-zhangjiakou.cr.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Parse tag and set variables
        id: parse_tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/docker/* ]]; then
            TAG_PATH="${{ github.ref }}"
            TAG_PATH="${TAG_PATH#refs/tags/}"

            COMPONENT=$(echo "$TAG_PATH" | cut -d'/' -f2)
            IMAGE_TAG=$(echo "$TAG_PATH" | cut -d'/' -f3)

            echo "component=$COMPONENT" >> $GITHUB_OUTPUT
            echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          else
            echo "component=${{ inputs.component }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Build and push to registries
        run: |
          COMPONENT="${{ steps.parse_tag.outputs.component }}"
          IMAGE_TAG="${{ steps.parse_tag.outputs.image_tag }}"

          if [ "$COMPONENT" == "execd" ]; then
            cd components/execd
          elif [ "$COMPONENT" == "ingress" ]; then
            cd components/ingress
          elif [ "$COMPONENT" == "egress" ]; then
            cd components/egress
          else
            cd sandboxes/$COMPONENT
          fi

          export TAG=$IMAGE_TAG
          chmod +x build.sh
          ./build.sh

      - name: Update Component Version in Docs
        if: steps.parse_tag.outputs.image_tag != 'latest'
        run: |
          COMPONENT="${{ steps.parse_tag.outputs.component }}"
          IMAGE_TAG="${{ steps.parse_tag.outputs.image_tag }}"
          
          echo "Updating documentation for component: $COMPONENT to version: $IMAGE_TAG"

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # We need to switch to main branch to push changes
          git fetch origin main
          git checkout main
          git pull origin main
          
          # Determine version file path
          if [[ "$COMPONENT" == "code-interpreter" ]]; then
             VERSION_FILE="sandboxes/code-interpreter/VERSION_TAG"
          elif [[ "$COMPONENT" == "execd" ]]; then
             VERSION_FILE="components/execd/VERSION_TAG"
          elif [[ "$COMPONENT" == "ingress" ]]; then
             VERSION_FILE="components/ingress/VERSION_TAG"
          elif [[ "$COMPONENT" == "egress" ]]; then
             VERSION_FILE="components/egress/VERSION_TAG"
          else
             echo "Unknown component for version update: $COMPONENT"
             exit 0
          fi
          
          # Update the version file
          echo "$IMAGE_TAG" > "$VERSION_FILE"
          
          # Run the update script for the specific component
          chmod +x scripts/manage_sandbox_version.py
          python3 scripts/manage_sandbox_version.py update --component "$COMPONENT"
          
          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: update $COMPONENT version to $IMAGE_TAG"
            git push origin main
            echo "Successfully updated documentation version for $COMPONENT."
          else
            echo "No changes detected."
          fi
